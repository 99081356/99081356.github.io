{% extends "base.html" %}

{% block title %}
    PDF示例
{% endblock %}

{% block head %}
    <style>
        #pdf-container {
            width: 100%; /* 或者你可以设置一个具体的宽度，比如 600px */
            height: 1080px; /* 设置一个具体的高度 */
            overflow: auto; /* 当内容超过容器大小时，显示滚动条 */
        }
    </style>
    <style>
        /* 定义加载中动画样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
{% endblock %}

{% block pageHeader %}
    <h2 class="page-title">
        PDF内容展示
    </h2>

{% endblock %}

{% block content %}

    <div class="row justify-content-center">

        <div class="col-lg-10 col-xl-9">
            <div class="card card-lg">
                <div class="card-body">
                    <!-- 加载中动画 -->
                    <div id="loadingOverlay" class="loading-overlay">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only"></span>
                        </div>
                    </div>

                    {#                    <iframe src="{{ url_for('static', filename='/pdfjs/web/viewer.html') }}" width="100%"#}
                    {#                            height="1080"></iframe>#}
                    <div class="btn-group float-end">
                        <!-- 添加放大缩小按钮 -->
                        <button id="zoomIn" class="btn btn-outline-dark">放大</button>
                        <button id="zoomOut" class="btn btn-outline-dark">缩小</button>
                    </div>
                    <div id="pdf-container">

                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script src="{{ url_for('static', filename='pdfjs/build/pdf.mjs') }}" type="module"></script>
    <script type="module">
        function fetchData() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            var scale = 1.0;
            var pdfDocument = null;
            var totalPages = 0;
            fetch('/remote_pdf')
                .then(response => response.text())
                .then(data => {
                    // 定义一个函数来渲染每一页
                    function renderPage(pageNum) {
                        pdfDocument.getPage(pageNum).then(function (page) {
                            console.log('Page ' + pageNum + ' loaded');
                            // 获取容器元素的尺寸
                            var container = document.getElementById('pdf-container');
                            var containerWidth = container.offsetWidth;
                            // 计算缩放比例
                            scale = containerWidth / page.getViewport({scale: 1.0}).width;
                            var viewport = page.getViewport({scale: scale});
                            // 获取对应的canvas元素
                            var canvas = document.getElementById('canvas-' + pageNum);
                            var context = canvas.getContext('2d');
                            // 设置canvas尺寸以适应页面
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            // 渲染PDF页面到canvas
                            var renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            var renderTask = page.render(renderContext);
                            renderTask.promise.then(function () {
                                console.log('Page ' + pageNum + ' rendered');
                            });
                        });
                    }

                    function renderPage_click(pageNum) {
                        pdfDocument.getPage(pageNum).then(function (page) {
                            console.log('Page ' + pageNum + ' loaded');
                            var viewport = page.getViewport({scale: scale});
                            // 获取对应的canvas元素
                            var canvas = document.getElementById('canvas-' + pageNum);
                            var context = canvas.getContext('2d');
                            // 设置canvas尺寸以适应页面
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            // 渲染PDF页面到canvas
                            var renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            var renderTask = page.render(renderContext);
                            renderTask.promise.then(function () {
                                console.log('Page ' + pageNum + ' rendered');
                            });
                        });
                    }

                    // 渲染每一页
                    function renderPages(startPage, endPage) {
                        for (var i = startPage; i <= endPage; i++) {
                            renderPage(i);
                        }
                        // 隐藏加载中动画
                        $('#loadingOverlay').addClass('d-none');
                    }

                    // 渲染每一页
                    function renderPages_click(startPage, endPage) {
                        for (var i = startPage; i <= endPage; i++) {
                            renderPage_click(i);
                        }
                        // 隐藏加载中动画
                        $('#loadingOverlay').addClass('d-none');
                    }

                    document.getElementById('zoomIn').addEventListener('click', function () {
                        scale *= 1.2; // 每次放大 20%
                        renderPages_click(1, totalPages);
                    });
                    document.getElementById('zoomOut').addEventListener('click', function () {
                        scale /= 1.2; // 每次缩小 20%
                        renderPages_click(1, totalPages);
                    });

                    // Loaded via <script> tag, create shortcut to access PDF.js exports.
                    var pdfData = atob(data);
                    var {pdfjsLib} = globalThis;

                    // The workerSrc property shall be specified.
                    pdfjsLib.GlobalWorkerOptions.workerSrc = '{{ url_for('static', filename='pdfjs/build/pdf.worker.mjs') }}';

                    // Using DocumentInitParameters object to load binary data.
                    var loadingTask = pdfjsLib.getDocument({data: pdfData});
                    loadingTask.promise.then(function (pdf) {
                        pdfDocument = pdf
                        console.log('PDF loaded');
                        // 获取总页数
                        totalPages = pdf.numPages;
                        // 为每一页创建一个canvas元素
                        for (var i = 1; i <= totalPages; i++) {
                            // 创建canvas元素
                            var canvas = document.createElement('canvas');
                            canvas.id = 'canvas-' + i;
                            // 将canvas添加到容器中
                            document.getElementById('pdf-container').appendChild(canvas);
                        }

                        renderPages(1, totalPages)
                        document.getElementById('loadingOverlay').style.display = 'none';
                    }, function (reason) {
                        // PDF loading error
                        console.error(reason);
                        document.getElementById('loadingOverlay').style.display = 'none';
                    });
                });
        }

        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
{% endblock %}
